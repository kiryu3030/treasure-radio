<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/static/images/favicon.ico" type="image/x-icon">
  <title>維修控制台</title>
  <script src="/static/jquery/jquery-3.6.4.min.js"></script>
  <script src="/static/socket-io-4.7.4/socket.io.js"></script>
  <script src="/static/js/layout.js"></script>
  <script src="/static/js/jquery.fittext.js"></script>
  <link rel="stylesheet" type="text/css" href="/static/bootstrap-5.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/static/bootstrap-icons-1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" type="text/css" href="/static/bootstrap-slider-11.0.2/css/bootstrap-slider.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/layout.css">
  <link rel="stylesheet" type="text/css" href="/static/css/index-input.css">
  <style>
  @font-face {
    font-family: NotoSansTC;
    src: url(../static/fonts/NotoSansTC-VariableFont_wght.ttf);
  }
  body {
    font-family: 'NotoSansTC', sans-serif;
    font-style: normal;
    background-color: black;
  }
  </style>
</head>
<body style="overflow-x: hidden;overflow-y: hidden;">
<header>
  <!-- Sidebar -->
  <nav id="sidebarMenu" class="collapse d-lg-block sidebar" style="background-color: #121212;">
    <div class="position-sticky">
      <div class="list-group list-group-flush mx-3 mt-4">
        <a id="bless" href="/" class="list-group-item list-group-item-action py-3 ripple item-base">
          <span>電源控制</span>
        </a>
        <a id="stepper" href="/stepper" class="list-group-item list-group-item-action py-3 ripple active item-base" aria-current="true">
          <span>馬達控制</span>
        </a>
      </div>
    </div>
  </nav>
  <!-- Sidebar -->

  <!-- Navbar -->
  <nav id="main-navbar" class="navbar navbar-expand-lg  fixed-top" style="background-color: black;">
    <!-- Container wrapper -->
    <div class="container-fluid">
      <!-- Toggle button -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu"
        aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <i class="bi bi-justify" style="color: white;"></i>
      </button>

      <!-- Brand -->
      <!-- <i class="bi bi-gear-wide" style="color: #b3b3b3;"></i> -->
      <a class="navbar-brand ms-1 fw-bolder a-text" style="font-size: 24px;" href="#">維修控制台</a>

      <!-- Right links -->
      <ul class="navbar-nav ms-auto d-flex flex-row">
      </ul>
    </div>
    <!-- Container wrapper -->
  </nav>
  <!-- Navbar -->
</header>
<!--Main Navigation-->
<div id="main-container" style="position: relative;overflow-x: hidden;overflow-y: hidden;">
  <div id="layer-mid" style="position: absolute;z-index: 2;overflow-x: hidden;overflow-y: hidden;">
    <div id="content-mid" style="position: relative;overflow-x: hidden;overflow-y: hidden;z-index: 2;color: white;">
      <header class="head-top" style="background-color: #004642;opacity: 1;">
        <div class="p-3 fw-bolder" style="font-size: 24px;">馬達控制</div>
      </header>
      
      <div id="setting-container" class="mostly-customized-scrollbar" style="overflow-x: hidden;overflow-y: scroll;position: relative;scroll-behavior: smooth;">
        <!-- <div id="scroll-point" class="top-bar-val top-bar">
          <div class="top-bar-bg d-flex align-items-end">
            <div class="p-3 fw-bolder" style="font-size: 34px;">電源控制</div>
          </div>
        </div> -->
        <div class="top-bar-val setting-layout p-3" style="margin-top: 70px;">
          <div style="width: 100%;">
            <div class="container-fluid">
              <div class="row">
                <div id="go-home" class="col-12">
                  <div class="card-item-title">回限位</div>
                  
                  <div class="row">
                    <div id="area-home" class="col-12 col-lg-6">
                      <div class="card-item-subtitle">#全區域</div>
                      <div class="card-item-body" style="justify-content:start">
                        <button type="button" class="btn btn-lg btn-secondary" data-home-cmd="0" aria-label="全區域回限位">全區域回限位</button>
                        <!-- <button type="button" class="btn btn-secondary" data-test-cmd="0" aria-label="測試馬達">測試馬達</button> -->
                      </div>
                    </div>

                    <div id="base-home" class="col-12 col-lg-6">
                      <div class="card-item-subtitle">#底座</div>
                      <label for="base-id" class="form-label">底座編號</label>
                      <input type="text" name="base" class="form-control" placeholder="底座編號 用空格分隔多個底座">
                      <!-- <div class="invalid-feedback text-end" style="font-size: 12px;">底座編號範圍1-140</div> -->
                      <div class="card-item-body" style="justify-content:center">
                        <button type="button" class="btn btn-lg btn-secondary" data-home-cmd="1" aria-label="底座回限位">底座回限位</button>
                        <!-- <button type="button" class="btn btn-secondary" data-test-cmd="0" aria-label="測試馬達">測試馬達</button> -->
                      </div>
                    </div>
                    
                  </div>
                  <!-- <div class="row mt-2">
                    <div class="col-12">
                      <div class="card-item-body" style="justify-content:center">
                        <button type="button" class="btn btn-secondary" data-calibrate-cmd="0" aria-label="歸零馬達">歸零馬達</button>
                        
                      </div>
                    </div>
                  </div> -->
                  
                  
                  
                </div>

              </div>
              <div class="row">
                <div id="calibrate" class="col-12">
                  <div class="card-item-title">歸零</div>
                  <div class="row">
                    <!-- area -->
                    <div id="area" class="col-12 col-lg-6">
                      <div class="card-item-subtitle">#全區域</div>
                      <div class="row">
                        <div class="col-12">
                          <label for="stepper-type" class="form-label" style="display: none;">馬達類型</label>
                          <select id="stepper-type" class="form-select" style="display: none;">
                            <option value="1">頸部</option>
                            <option value="2">底部</option>
                            <option value="3" selected>頸部+底部</option>
                          </select>
                          <div class="card-item-body" style="justify-content:start">
                            <button type="button" class="btn btn-lg btn-secondary" data-calibrate-cmd="2" aria-label="全區域歸零">全區域歸零</button>
                            <!-- <button type="button" class="btn btn-secondary" data-test-cmd="0" aria-label="測試馬達">測試馬達</button> -->
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- area -->
                    <div id="singel" class="col-12 col-lg-6">
                      <div class="card-item-subtitle">#單株</div>
                      <div class="row">
                        <div class="col-12">
                          <label for="flower-id" class="form-label">花株編號</label>
                          <input type="text" name="flower" id="flower-id" class="form-control" placeholder="花株編號 用空格分隔多個花株">
                          <div class="invalid-feedback text-end" style="font-size: 12px;">花株編號範圍1-560</div>
                        </div>
                        <div class="col-12">
                          <label for="stepper-type" class="form-label" style="display: none;">馬達類型</label>
                          <select id="stepper-type" class="form-select" style="display: none;">
                            <option value="1">頸部</option>
                            <option value="2">底部</option>
                            <option value="3" selected>頸部+底部</option>
                          </select>
                        </div>
                        <div class="card-item-body" style="justify-content:center">
                          <button type="button" class="btn btn-lg btn-secondary" data-calibrate-cmd="0" aria-label="單株歸零">單株歸零</button>
                          <!-- <button type="button" class="btn btn-secondary" data-test-cmd="0" aria-label="測試馬達">測試馬達</button> -->
                        </div>
                      </div>
                    </div>
                    <!-- singel -->
                    <div id="group" class="col-12 col-lg-6">
                      <div class="card-item-subtitle">#底座</div>
                      <div class="row">
                        <div class="col-12">
                          <label for="base-id" class="form-label">底座編號</label>
                          <input type="text" name="base" id="base-id" class="form-control"  placeholder="底座編號 用空格分隔多個底座">
                          <div class="invalid-feedback text-end" style="font-size: 12px;">底座編號範圍1-150</div>
                        </div>
                        <div class="col-12">
                          <label for="stepper-type" class="form-label" style="display: none;">馬達類型</label>
                          <select id="stepper-type" class="form-select" style="display: none;">
                            <option value="1">頸部</option>
                            <option value="2">底部</option>
                            <option value="3" selected>頸部+底部</option>
                          </select>
                        </div>
                      </div>
                      <div class="row mt-2">
                        <div class="col-12">
                          <div class="card-item-body" style="justify-content:center">
                            <button type="button" class="btn btn-lg btn-secondary" data-calibrate-cmd="1" aria-label="底座歸零">底座歸零</button>
                            <!-- <button type="button" class="btn btn-secondary" data-test-cmd="0" aria-label="測試馬達">測試馬達</button> -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
            <div style="height: 1080px;"></div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  <!-- load Modal -->
  <div class="modal fade" id="load-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="load-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row flex-column">
              <div class="col pt-2"><div class="loading"></div></div>
              <div class="col">
                <p id="load-modal-title" class="text-center" style="font-size: 20px;margin-top: 15px;">等待裝置回應</p>
              </div>
              <div class="col">
                <p id="load-timer" class="text-center" style="font-size: 12px;"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- alert Modal -->
  <div class="modal fade" id="alert-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="alert-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm text-dark">
      <div class="modal-content">
        <!-- <div class="modal-header">
          
        </div> -->
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-sm-12">
              <div id="alert-title" class="text-center">錯誤</div>
              <hr>
              <div id="alert-msg"></div>
            </div>
          </div>
          <div class="d-flex justify-content-center pt-2">
            <!-- <button type="button" class="config-button mx-3" data-bs-dismiss="modal" aria-label="Close">否</button> -->
            <button id="alert-close" type="button" class="btn btn-dark" data-bs-dismiss="modal" aria-label="Close">確定</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="shutdown-modal" tabindex="-1" aria-labelledby="shutdown-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm text-dark">
      <div class="modal-content">
        <div id="shutdown-form" class="modal-body">
          <div class="row" style="height: 200px;">
            <div class="col-12 align-self-center">
              <div class="row flex-column align-items-center">
                <div class="col-8 text-center" style="font-size: 24px;">是 否 關 閉 系 統</div>
                <div class="col-10 text-center" style="margin-top: 40px;">
                  <button type="button" class="btn btn-dark mx-3" data-bs-dismiss="modal" aria-label="Close">否</button>
                  <button id="shutdown" type="button" class="btn btn-dark mx-3">是</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="/static/bootstrap-5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="/static/bootstrap-slider-11.0.2/js/bootstrap-slider.js"></script>
<script>
var alertModal = bootstrap.Modal.getOrCreateInstance(document.querySelector('#alert-modal'));
var shutdownModal = bootstrap.Modal.getOrCreateInstance(document.querySelector('#shutdown-modal'));
var loadModal = bootstrap.Modal.getOrCreateInstance(document.querySelector('#load-modal'));

function showAlert(data) {
  $("#alert-msg").html(data['msg']);
  alertModal.show();
}
function showLoading(data) {
  $("#load-modal-title").html(data);
  loadModal.show();
}
</script>
<script>
function ctrlHome(id, cmdName, base){
  showLoading(cmdName);
  $.ajax({
    type: "GET",
    url: `/api/stepper/home/${id}?base=${base}`,
    dataType: "json",
    contentType: "application/json",
  })
  .done(function(data) {
    console.log(data);
  })
  .always(function() {
    loadModal.hide();
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    showAlert(jqXHR.responseJSON);
  });
}
$("#go-home .btn").click(function() {
  let id = $(this).data("home-cmd");
  let cmdName = $(this).attr('aria-label');
  let base = $("#base-home input[name='base']").val();
  console.log(id);
  console.log(cmdName);
  console.log(base);
  ctrlHome(id, cmdName, base);
});

// $("#calibrate .btn").click(function() {
//   let id = $(this).data("calibrate-cmd");
//   let cmdName = $(this).attr('aria-label');
//   let base = $("#base-home input[name='base']").val();
//   console.log(id);
//   console.log(cmdName);
//   console.log(base);
//   ctrlHome(id, cmdName, base);
// });
function ctrlLed(id, cmdName){
  showLoading(cmdName);
  $.ajax({
    type: "GET",
    url: `/api/led/${id}`,
    dataType: "json",
    contentType: "application/json",
  })
  .done(function(data) {
    console.log(data);
  })
  .always(function() {
    loadModal.hide();
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    showAlert(jqXHR.responseJSON);
  });
}
$("#led .btn").click(function() {
  let id = $(this).data("led");
  let cmdName = $(this).attr('aria-label');
  console.log(id);
  console.log(cmdName);
  ctrlLed(id, cmdName);
});

function ctrlCalibrate(id, cmdName, cmd){
  showLoading(cmdName);
  $.ajax({
    type: "POST",
    url: `/api/stepper/adjustment/${id}`,
    dataType: "json",
    contentType: "application/json",
    data: JSON.stringify(cmd)
  })
  .done(function(data) {
    console.log(data);
  })
  .always(function() {
    loadModal.hide();
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    showAlert(jqXHR.responseJSON);
  });
}
// function ctrlCalibrate1(id, cmdName, base){
//   showLoading(cmdName);
//   $.ajax({
//     type: "GET",
//     url: `/api/stepper/home/${id}?base=${base}`,
//     dataType: "json",
//     contentType: "application/json",
//   })
//   .done(function(data) {
//     console.log(data);
//   })
//   .always(function() {
//     loadModal.hide();
//   })
//   .fail(function(jqXHR, textStatus, errorThrown) {
//     showAlert(jqXHR.responseJSON);
//   });
// }
$(`[data-calibrate-cmd]`).click(function() {
  let calibrateCmd = $(this).data("calibrate-cmd");
  let cmdName = $(this).attr('aria-label');
  console.log(calibrateCmd);
  let calibrateName = "";
  switch(calibrateCmd){
    case 0:
      calibrateName = "singel";
      break;
    case 1:
      calibrateName = "group";
      break;
    case 2:
      calibrateName = "area";
      break;
    default:
      break;
  }
  if(calibrateName=="") return;
  let baseId = $(`#calibrate #${calibrateName} #base-id`).val();
  let flowerId = $(`#calibrate #${calibrateName} #flower-id`).val();
  let stepperType = $(`#calibrate #${calibrateName} #stepper-type option:selected`).val();
  console.log(baseId);
  console.log(flowerId);
  console.log(stepperType);
  if(baseId=="" && calibrateCmd!=2) return;
  console.log("pass");
  switch(calibrateCmd){
    case 0:{
      calibrateName = "singel";
      let cmd = {"flowerId": flowerId, "stepperType": stepperType};
      // console.log(cmd);
      ctrlCalibrate(calibrateName, cmdName, cmd);
      break;
    }
    case 1:
      calibrateName = "group";
      // ctrlCalibrate(id, cmdName, postData)
      break;
    case 2:{
      calibrateName = "area";
      let cmd = {"stepperType": stepperType};
      ctrlCalibrate(calibrateName, cmdName, cmd);
      break;
    }
    default:
      break;
  }
});


</script>
<script>
$(window).resize(function() {
  SetupWindow();
});

$(window).ready(function() {
  SetupWindow();
});
// $("#setting-container").on("scroll",()=>{
//   if($("#scroll-point").offset().top<-18) $(".head-top").css('opacity', 1);
//   else $(".head-top").css('opacity', 0);
// });
</script>
</body>
</html>
